// ì›¨ì¼ í™•ì¥í”„ë¡œê·¸ë¨ íŒì—… ìŠ¤í¬ë¦½íŠ¸
// ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ê°œì„  ë° ì›¨ì¼ íŠ¹í™” ê¸°ëŠ¥

document.addEventListener('DOMContentLoaded', function() {
    initializePopup();
    loadUserSettings();
    setupEventListeners();
});

// íŒì—… ì´ˆê¸°í™”
function initializePopup() {
    console.log('ì›¨ì¼ ë°”ë¡œê°€ê¸° ë„êµ¬ íŒì—…ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.');
    
    // í˜„ì¬ ì„ íƒëœ í…ìŠ¤íŠ¸ í™•ì¸
    chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
        chrome.tabs.sendMessage(tabs[0].id, {
            action: 'getSelectedText'
        }, function(response) {
            if (response && response.text) {
                updateKBButtonText(response.text);
            }
        });
    });
    
    // ì‚¬ìš© í†µê³„ ì—…ë°ì´íŠ¸
    updateUsageStats();
}

// ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
function loadUserSettings() {
    chrome.storage.sync.get([
        'openInNewTab',
        'copyToClipboard', 
        'showNotifications'
    ], function(result) {
        // ì„¤ì •ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        const settings = {
            openInNewTab: result.openInNewTab || false,
            copyToClipboard: result.copyToClipboard !== false,
            showNotifications: result.showNotifications !== false
        };
        
        console.log('ë¡œë“œëœ ì„¤ì •:', settings);
    });
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    // LTVê³„ì‚°ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('ltvBtn').addEventListener('click', function() {
        animateButton(this);
        
        chrome.runtime.sendMessage({
            action: 'openLTV'
        });
        
        // ì‚¬ìš© íšŸìˆ˜ ì¦ê°€
        incrementUsageCount('ltv');
        
        setTimeout(() => window.close(), 200);
    });
    
    // KBì‹œì„¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('kbBtn').addEventListener('click', function() {
        animateButton(this);
        
        // í˜„ì¬ í™œì„± íƒ­ì—ì„œ ì„ íƒëœ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
            chrome.tabs.executeScript(tabs[0].id, {
                code: 'window.getSelection().toString().trim();'
            }, function(result) {
                const selectedText = result && result[0] ? result[0] : '';
                
                chrome.runtime.sendMessage({
                    action: 'openKB',
                    text: selectedText
                });
                
                // ì‚¬ìš© íšŸìˆ˜ ì¦ê°€
                incrementUsageCount('kb');
            });
        });
        
        setTimeout(() => window.close(), 200);
    });
    
    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì•ˆë‚´ í˜¸ë²„ íš¨ê³¼
    const shortcuts = document.querySelectorAll('.button-shortcut');
    shortcuts.forEach(shortcut => {
        shortcut.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(255, 255, 255, 0.3)';
        });
        
        shortcut.addEventListener('mouseleave', function() {
            this.style.background = 'rgba(255, 255, 255, 0.1)';
        });
    });
}

// KBë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
function updateKBButtonText(selectedText) {
    const kbBtn = document.getElementById('kbBtn');
    const buttonText = kbBtn.querySelector('.button-text');
    
    if (selectedText && selectedText.length > 0) {
        const displayText = selectedText.length > 15 ? 
            selectedText.substring(0, 15) + '...' : selectedText;
        buttonText.textContent = `"${displayText}" KBì‹œì„¸ í™•ì¸`;
        
        // ë²„íŠ¼ì— ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ìˆìŒì„ ì‹œê°ì ìœ¼ë¡œ í‘œì‹œ
        kbBtn.style.background = 'rgba(255, 255, 255, 0.25)';
        kbBtn.style.border = '1px solid rgba(255, 255, 255, 0.4)';
    } else {
        buttonText.textContent = 'KBì‹œì„¸ ë°”ë¡œê°€ê¸°';
        kbBtn.style.background = 'rgba(255, 255, 255, 0.15)';
        kbBtn.style.border = '1px solid rgba(255, 255, 255, 0.2)';
    }
}

// ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜
function animateButton(button) {
    button.style.transform = 'scale(0.95)';
    button.style.background = 'rgba(255, 255, 255, 0.35)';
    
    setTimeout(() => {
        button.style.transform = 'scale(1)';
        button.style.background = 'rgba(255, 255, 255, 0.25)';
    }, 100);
}

// ì‚¬ìš© íšŸìˆ˜ ì¦ê°€
function incrementUsageCount(type) {
    chrome.storage.local.get(['usageStats'], function(result) {
        const stats = result.usageStats || {
            ltv: 0,
            kb: 0,
            totalUsage: 0,
            lastUsed: null
        };
        
        stats[type]++;
        stats.totalUsage++;
        stats.lastUsed = Date.now();
        
        chrome.storage.local.set({usageStats: stats});
        console.log(`${type.toUpperCase()} ì‚¬ìš© íšŸìˆ˜: ${stats[type]}`);
    });
}

// ì‚¬ìš© í†µê³„ ì—…ë°ì´íŠ¸
function updateUsageStats() {
    chrome.storage.local.get(['usageStats'], function(result) {
        const stats = result.usageStats;
        
        if (stats && stats.totalUsage > 0) {
            // ì´ ì‚¬ìš© íšŸìˆ˜ê°€ 10íšŒ ì´ìƒì´ë©´ ê°ì‚¬ ë©”ì‹œì§€ í‘œì‹œ
            if (stats.totalUsage >= 10 && stats.totalUsage % 10 === 0) {
                showThankYouMessage(stats.totalUsage);
            }
        }
    });
}

// ê°ì‚¬ ë©”ì‹œì§€ í‘œì‹œ
function showThankYouMessage(totalUsage) {
    const footer = document.querySelector('.footer');
    if (footer) {
        footer.innerHTML = `
            ğŸ‰ ${totalUsage}íšŒ ì‚¬ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!
        `;
        footer.style.color = '#FFE082';
        footer.style.fontWeight = '600';
    }
}

// ì—ëŸ¬ ì²˜ë¦¬
window.addEventListener('error', function(e) {
    console.error('ì›¨ì¼ íŒì—… ì—ëŸ¬:', e.error);
});

// íŒì—…ì´ ë‹«í ë•Œ ì •ë¦¬
window.addEventListener('beforeunload', function() {
    console.log('ì›¨ì¼ ë°”ë¡œê°€ê¸° ë„êµ¬ íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.');
});